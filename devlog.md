开发日志
=================

[TOC]

# CPU调整到riscv64指令集 2019.9.3-

- 调整数据通路宽度到64
- 调整DCache读写宽度
- 调整外围内存, 总线配置
- 引入新指令

## 模块改动说明

### Cache

* Cache64: 64位数据缓存, 使用64位地址
* 目前所有的Cache对外数据宽度均为64

RV64指令集中, 地址非对齐的访存结果是实现相关的, 为了简化设计, 这里对非对齐的访存不做特殊处理

TODO: IMM变化 1 
TODO: 32位乘法器/除法器 1
TODO: RESET VECTOR
TODO: 64 bit AddressSpace 分配
TODO: cache直接使用参数改成64位的效果尚未测试
TODO: 特权寄存器变更
TODO: simple bus 调整和 AXI4 调整 1

## 新指令列表

```
指令|模式|当前进度
---     |BitPat("b1098765_43210_98765_432_10987_6543210")|-
LWU     |BitPat("b???????_?????_?????_110_?????_0000011")|1
LD      |BitPat("b???????_?????_?????_011_?????_0000011")|1
SD      |BitPat("b???????_?????_?????_011_?????_0100011")|1
SLLI    |BitPat("b0000000_?????_?????_001_?????_0010011")|1
SRLI    |BitPat("b0000000_?????_?????_101_?????_0010011")|1
SRAI    |BitPat("b0100000_?????_?????_101_?????_0010011")|1
ADDIW   |BitPat("b???????_?????_?????_000_?????_0011011")|1
SLLIW   |BitPat("b0000000_?????_?????_001_?????_0011011")|1
SRLIW   |BitPat("b0000000_?????_?????_101_?????_0011011")|1
SRAIW   |BitPat("b0100000_?????_?????_101_?????_0011011")|1
ADDW    |BitPat("b0000000_?????_?????_000_?????_0111011")|1
SUBW    |BitPat("b0100000_?????_?????_000_?????_0111011")|1
SLLW    |BitPat("b0000000_?????_?????_001_?????_0111011")|1
SRLW    |BitPat("b0000000_?????_?????_101_?????_0111011")|1
SRAW    |BitPat("b0100000_?????_?????_101_?????_0111011")|1

MULW    |BitPat("b0100000_?????_?????_101_?????_0111011")|1
DIVW    |BitPat("b0100000_?????_?????_101_?????_0111011")|1
DIVUW   |BitPat("b0100000_?????_?????_101_?????_0111011")|1
REMW    |BitPat("b0100000_?????_?????_101_?????_0111011")|1
REMUW   |BitPat("b0100000_?????_?????_101_?????_0111011")|1
```

其他要调整的指令
* LX/SX
* ALUI

# RVC指令集及流水线变动

检查下列指令的nemu实现
```
    8010074a:	80fd                	srli	s1,s1,0x1f
```


# BPU, RVC基本完工, 系统调试中 2019.10.9-

TODO:

* 优化调试基础设施
* 合并分支
* 原子指令
* RTT
* freert
* ucasos-lite
* BPU优化
* BPU flush
* xv6

---

主要进展及遇到问题如下:

## 0.1. 切换到新版本的AM之后, microbench测试时出现了奇怪的现象:

```
======= Running MicroBench [input *ref*] =======
[] : cpu.pc 80003898
emu: src/isa/riscv64/decode.c:331: decode_C_ADDI4SPN: Assertion `imm != 0' failed.
```

对应代码段如下:

```
    80103894:	02d00793          	li	a5,45
    80103898:	0cfb8263          	beq	s7,a5,8010395c <vprintdec+0x12a>
    8010389c:	0a904963          	bgtz	s1,8010394e <vprintdec+0x11c>
```

## 0.2. RTThread

有bug, WIP

## 0.3. FreeRTOS

链接库时存在问题, 需要调整环境.

```
/opt/riscv-toolchain-2018.08.17/bin/../lib/gcc/riscv64-unknown-elf/7.2.0/../../../../riscv64-unknown-elf/bin/ld: 
/opt/riscv-toolchain-2018.08.17/bin/../lib/gcc/riscv64-unknown-elf/7.2.0/libgcc.a(_clzsi2.o): 
can't link hard-float modules with soft-float modules
```

## 0.4. Merge & Test

WIP

## 0.5. UCASOS

切换到较简洁的 `UCASOS-lite` (未使用am, 主要为简单调度/同步功能), 需要最新分支中更改和原子指令, 暂未测试

## 0.6. BPU

一种特殊情况还需优化, WIP